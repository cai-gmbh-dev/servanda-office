# Servanda Office — Main Gate
# Based on: qa-gates-ci-v1.md, a11y-performance-baseline-v1.md
# Runs after merge to main.
# Includes E2E tests, Lighthouse, and security scans.

name: Main Gate

on:
  push:
    branches: [main]

jobs:
  # --- Full Test Suite ---
  test-full:
    name: Full Test Suite
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: servanda_office_test
          POSTGRES_USER: servanda
          POSTGRES_PASSWORD: servanda_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U servanda"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://servanda:servanda_test@localhost:5432/servanda_office_test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run db:generate
      - run: npm run test:coverage

  # --- Build + Docker Image ---
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run build
      # TODO: Docker build + push when Dockerfiles are ready
      # - name: Build API image
      #   run: docker build -t servanda-api:${{ github.sha }} -f docker/Dockerfile.api .
      # - name: Build Worker image
      #   run: docker build -t servanda-worker:${{ github.sha }} -f docker/Dockerfile.worker .

  # --- Lighthouse (Performance + Accessibility) ---
  lighthouse:
    name: Lighthouse (≥85 Perf, ≥90 A11y)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run build:web
      # TODO: Enable when frontend is ready
      # - run: npx serve apps/web/dist -l 3000 &
      # - run: npx wait-on http://localhost:3000
      # - name: Run Lighthouse CI
      #   uses: treosh/lighthouse-ci-action@v11
      #   with:
      #     urls: |
      #       http://localhost:3000/
      #       http://localhost:3000/dashboard
      #     configPath: ./lighthouserc.json

  # --- Dependency Security Scan ---
  security:
    name: Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm audit --audit-level=high || true
      # TODO: Add Trivy container scan when Docker images are built

# =============================================================================
# Servanda Office Helm Chart - Default Values
# =============================================================================
# This file contains the default configuration for all deployment scenarios.
# Override with environment-specific values files:
#   helm install ... -f values-dev.yaml
#   helm install ... -f values-staging.yaml
#   helm install ... -f values-prod.yaml
#   helm install ... -f values-onprem.yaml
# =============================================================================

# -- Global settings applied to all components
global:
  # -- Kubernetes namespace for all resources
  namespace: servanda-office
  # -- Default image pull policy (Always, IfNotPresent, Never)
  imagePullPolicy: IfNotPresent
  # -- Default image tag for all Servanda components
  imageTag: "latest"
  # -- Image pull secrets for private registries
  imagePullSecrets: []
  #   - name: ghcr-credentials
  # -- Common labels applied to all resources
  labels: {}
  # -- Common annotations applied to all resources
  annotations: {}

# =============================================================================
# API Server
# =============================================================================
api:
  # -- Number of API server replicas
  replicas: 2
  image:
    repository: ghcr.io/cai-gmbh-dev/servanda-office/api
    # -- Overrides global.imageTag
    tag: ""
    pullPolicy: ""
  # -- Resource requests and limits
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  # -- Environment variables for the API server
  env:
    NODE_ENV: production
    PORT: "3000"
    # -- OIDC Issuer URL (Keycloak realm)
    OIDC_ISSUER_URL: "http://keycloak:8080/realms/servanda"
    # -- OIDC Client ID
    OIDC_CLIENT_ID: "servanda-api"
    # -- S3 bucket name
    S3_BUCKET: "servanda-office"
    # -- Feature flag: ODT export support
    FEATURE_ODT_EXPORT: "false"
  # -- Service configuration
  service:
    type: ClusterIP
    port: 3000
    targetPort: 3000
  # -- Liveness probe configuration
  livenessProbe:
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 15
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  # -- Readiness probe configuration
  readinessProbe:
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  # -- Pod annotations
  podAnnotations: {}
  # -- Node selector
  nodeSelector: {}
  # -- Tolerations
  tolerations: []
  # -- Affinity rules
  affinity: {}
  # -- Security context for the pod
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  # -- Security context for the container
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

# =============================================================================
# Web Frontend
# =============================================================================
web:
  # -- Number of web frontend replicas
  replicas: 2
  image:
    repository: ghcr.io/cai-gmbh-dev/servanda-office/web
    tag: ""
    pullPolicy: ""
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"
  service:
    type: ClusterIP
    port: 80
    targetPort: 80
  livenessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 3
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 3
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  podAnnotations: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101
    fsGroup: 101
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

# =============================================================================
# Export Worker
# =============================================================================
exportWorker:
  # -- Number of export worker replicas
  replicas: 1
  image:
    repository: ghcr.io/cai-gmbh-dev/servanda-office/export-worker
    tag: ""
    pullPolicy: ""
  resources:
    requests:
      memory: "256Mi"
      cpu: "200m"
    limits:
      memory: "1Gi"
      cpu: "1000m"
  # -- Environment variables for the export worker
  env:
    NODE_ENV: production
    # -- pgboss job concurrency
    EXPORT_CONCURRENCY: "2"
    # -- S3 bucket name for exports
    S3_BUCKET: "servanda-office"
    # -- Feature flag: ODT export
    FEATURE_ODT_EXPORT: "false"
  podAnnotations: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

# =============================================================================
# Ingress
# =============================================================================
ingress:
  # -- Enable ingress resource
  enabled: true
  # -- Ingress class name
  className: nginx
  # -- Ingress annotations
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/limit-rps: "20"
    nginx.ingress.kubernetes.io/limit-connections: "10"
    nginx.ingress.kubernetes.io/limit-rpm: "300"
  # -- Ingress host
  host: app.servanda.de
  # -- TLS configuration
  tls:
    enabled: true
    secretName: servanda-tls

# =============================================================================
# Horizontal Pod Autoscaler (HPA)
# =============================================================================
hpa:
  # -- Enable HPA for API and worker
  enabled: true
  api:
    minReplicas: 2
    maxReplicas: 8
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    # -- Scale-down stabilization window (seconds)
    scaleDownStabilizationSeconds: 300
    # -- Scale-up stabilization window (seconds)
    scaleUpStabilizationSeconds: 60
  worker:
    minReplicas: 1
    maxReplicas: 4
    targetCPUUtilizationPercentage: 80
    scaleDownStabilizationSeconds: 300
    scaleUpStabilizationSeconds: 60

# =============================================================================
# PostgreSQL (in-cluster for dev, external for prod)
# =============================================================================
postgresql:
  # -- Enable in-cluster PostgreSQL (true for dev, false for prod with external DB)
  enabled: true
  image:
    repository: postgres
    tag: "16-alpine"
  # -- Storage size for PostgreSQL PVC
  storage: 10Gi
  # -- Storage class (leave empty for default)
  storageClassName: ""
  # -- Database credentials
  credentials:
    database: servanda_office
    username: servanda
    # -- Password (override via secrets in prod)
    password: servanda_dev
  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

# =============================================================================
# Keycloak (OIDC / Identity)
# =============================================================================
keycloak:
  # -- Enable in-cluster Keycloak
  enabled: true
  image:
    repository: quay.io/keycloak/keycloak
    tag: "24.0"
  # -- Admin credentials
  adminCredentials:
    username: admin
    # -- Override via secrets in prod
    password: admin
  # -- Import realm configuration on startup
  realmImport:
    enabled: true
  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

# =============================================================================
# MinIO (S3-compatible object storage)
# =============================================================================
minio:
  # -- Enable in-cluster MinIO (true for dev/onprem, false for prod with AWS S3)
  enabled: true
  image:
    repository: minio/minio
    tag: "latest"
  # -- MinIO credentials
  credentials:
    rootUser: minioadmin
    rootPassword: minioadmin
  # -- Default bucket name
  bucketName: servanda-office
  # -- Storage size for MinIO PVC
  storage: 10Gi
  storageClassName: ""
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# =============================================================================
# OpenSearch (Full-Text Search — Phase 2)
# =============================================================================
opensearch:
  # -- Enable OpenSearch (disabled by default, Phase 2 feature)
  enabled: false
  image:
    repository: opensearchproject/opensearch
    tag: "2.11.0"
  # -- Number of OpenSearch replicas
  replicas: 1
  resources:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "1Gi"
      cpu: "1000m"
  # -- Storage size for OpenSearch PVC
  storage: 10Gi
  storageClassName: ""
  # -- Disable security plugin for dev (MUST be true in prod)
  securityDisabled: true
  # -- OpenSearch Java options
  javaOpts: "-Xms512m -Xmx512m"
  # -- OpenSearch Dashboards
  dashboards:
    enabled: false
    image:
      repository: opensearchproject/opensearch-dashboards
      tag: "2.11.0"
    resources:
      requests:
        memory: "256Mi"
        cpu: "200m"
      limits:
        memory: "512Mi"
        cpu: "500m"

# =============================================================================
# Secrets (base64 placeholders — override in prod)
# =============================================================================
secrets:
  # -- Database connection URL
  databaseUrl: "postgresql://servanda:servanda_dev@servanda-postgres:5432/servanda_office"
  # -- S3 credentials
  s3:
    endpoint: "http://servanda-minio:9000"
    accessKey: "minioadmin"
    secretKey: "minioadmin"
  # -- OIDC client secret
  oidcClientSecret: "changeme"
  # -- Use external secrets (ExternalSecret CRDs) instead of in-chart secrets
  external:
    enabled: false
    # -- ClusterSecretStore name for External Secrets Operator
    secretStoreName: "aws-secrets-manager"

# =============================================================================
# Monitoring
# =============================================================================
monitoring:
  # -- Enable Prometheus ServiceMonitor
  prometheus:
    enabled: true
    # -- Scrape interval
    interval: "15s"
    # -- Scrape path
    path: "/metrics"
  # -- Enable Grafana dashboards ConfigMap
  grafana:
    enabled: true

# =============================================================================
# Shared Configuration (ConfigMap)
# =============================================================================
config:
  # -- Node environment
  nodeEnv: production
  # -- API port
  port: "3000"
  # -- S3 bucket name
  s3Bucket: "servanda-office"
  # -- Feature flags
  featureOdtExport: "false"
  # -- OIDC Issuer URL
  oidcIssuerUrl: "http://keycloak:8080/realms/servanda"

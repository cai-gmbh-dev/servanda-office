apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "servanda-office.fullname" . }}-test-api"
  namespace: {{ include "servanda-office.namespace" . }}
  labels:
    {{- include "servanda-office.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
spec:
  restartPolicy: Never
  containers:
    - name: test-api
      image: busybox:1.36
      command:
        - /bin/sh
        - -c
        - |
          echo "=== Servanda Office API Health Check ==="
          echo "Testing: {{ include "servanda-office.fullname" . }}-api:{{ .Values.api.service.port }}"

          # Wait for service to be ready (max 60 seconds)
          ATTEMPTS=0
          MAX_ATTEMPTS=12
          SLEEP_INTERVAL=5

          while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
            ATTEMPTS=$((ATTEMPTS + 1))
            echo "Attempt ${ATTEMPTS}/${MAX_ATTEMPTS}..."

            if wget -q -O /dev/null -T 5 \
              "http://{{ include "servanda-office.fullname" . }}-api:{{ .Values.api.service.port }}/api/health" 2>/dev/null; then
              echo "[PASS] API server is reachable and healthy"
              exit 0
            fi

            echo "  Not ready yet, waiting ${SLEEP_INTERVAL}s..."
            sleep $SLEEP_INTERVAL
          done

          echo "[FAIL] API server did not become healthy within $((MAX_ATTEMPTS * SLEEP_INTERVAL))s"
          exit 1

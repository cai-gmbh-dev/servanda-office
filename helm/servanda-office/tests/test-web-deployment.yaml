apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "servanda-office.fullname" . }}-test-web"
  namespace: {{ include "servanda-office.namespace" . }}
  labels:
    {{- include "servanda-office.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
spec:
  restartPolicy: Never
  containers:
    - name: test-web
      image: busybox:1.36
      command:
        - /bin/sh
        - -c
        - |
          echo "=== Servanda Office Web Health Check ==="
          echo "Testing: {{ include "servanda-office.fullname" . }}-web:{{ .Values.web.service.port }}"

          # Wait for service to be ready (max 60 seconds)
          ATTEMPTS=0
          MAX_ATTEMPTS=12
          SLEEP_INTERVAL=5

          while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
            ATTEMPTS=$((ATTEMPTS + 1))
            echo "Attempt ${ATTEMPTS}/${MAX_ATTEMPTS}..."

            if wget -q -O /dev/null -T 5 \
              "http://{{ include "servanda-office.fullname" . }}-web:{{ .Values.web.service.port }}/" 2>/dev/null; then
              echo "[PASS] Web frontend is reachable"
              exit 0
            fi

            echo "  Not ready yet, waiting ${SLEEP_INTERVAL}s..."
            sleep $SLEEP_INTERVAL
          done

          echo "[FAIL] Web frontend did not become reachable within $((MAX_ATTEMPTS * SLEEP_INTERVAL))s"
          exit 1

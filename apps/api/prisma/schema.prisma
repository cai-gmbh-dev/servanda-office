// Servanda Office â€” Prisma Schema v1
// Based on: domain-model-v1.md, ADR-001 (RLS), ADR-002 (Version Pinning)
//
// Note: RLS policies are applied via raw SQL migrations (not Prisma-managed).
// Every tenant-scoped table has tenant_id + RLS enabled.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// PLATFORM CONTEXT
// ============================================================

model Tenant {
  id                  String   @id @default(uuid()) @db.Uuid
  name                String   @db.VarChar(255)
  type                String   @db.VarChar(20) // vendor | lawfirm | individual
  slug                String   @unique @db.VarChar(63)
  addressStreet       String?  @map("address_street") @db.VarChar(500)
  addressZip          String?  @map("address_zip") @db.VarChar(20)
  addressCity         String?  @map("address_city") @db.VarChar(255)
  addressCountry      String?  @map("address_country") @db.VarChar(10)
  defaultJurisdiction String   @map("default_jurisdiction") @db.VarChar(10)
  defaultLanguage     String   @default("de") @map("default_language") @db.VarChar(5)
  settings            Json?    @db.JsonB
  status              String   @default("active") @db.VarChar(20) // active | suspended | deleted
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  users              User[]
  teams              Team[]
  auditEvents        AuditEvent[]
  clauses            Clause[]
  templates          Template[]
  interviewFlows     InterviewFlow[]
  contractInstances  ContractInstance[]
  lawFirmTemplates   LawFirmTemplate[]
  exportJobs         ExportJob[]
  styleTemplates     StyleTemplate[]

  @@map("tenants")
}

model User {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  email       String   @db.VarChar(255)
  displayName String   @map("display_name") @db.VarChar(255)
  role        String   @db.VarChar(20) // admin | editor | user
  status      String   @default("invited") @db.VarChar(20) // invited | active | disabled
  keycloakId  String?  @map("keycloak_id") @db.VarChar(255)
  mfaEnabled  Boolean  @default(false) @map("mfa_enabled")
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime @default(now()) @map("created_at")

  tenant               Tenant             @relation(fields: [tenantId], references: [id])
  authoredClauseVersions    ClauseVersion[]   @relation("ClauseVersionAuthor")
  reviewedClauseVersions    ClauseVersion[]   @relation("ClauseVersionReviewer")
  authoredTemplateVersions  TemplateVersion[] @relation("TemplateVersionAuthor")
  reviewedTemplateVersions  TemplateVersion[] @relation("TemplateVersionReviewer")
  createdContracts          ContractInstance[] @relation("ContractCreator")
  requestedExports          ExportJob[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

model Team {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  name      String   @db.VarChar(255)
  memberIds String[] @map("member_ids") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("teams")
}

model AuditEvent {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  actorId    String?  @map("actor_id") @db.Uuid
  action     String   @db.VarChar(100)
  objectType String   @map("object_type") @db.VarChar(100)
  objectId   String   @map("object_id") @db.Uuid
  details    Json?    @db.JsonB
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.VarChar(500)
  timestamp  DateTime @default(now())

  tenant     Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId, timestamp(sort: Desc)])
  @@index([tenantId, action])
  @@index([tenantId, objectType, objectId])
  @@map("audit_events")
}

// ============================================================
// CONTENT CONTEXT (Publisher)
// ============================================================

model Clause {
  id                        String   @id @default(uuid()) @db.Uuid
  tenantId                  String   @map("tenant_id") @db.Uuid
  title                     String   @db.VarChar(500)
  tags                      String[] @default([])
  jurisdiction              String   @db.VarChar(10)
  legalArea                 String?  @map("legal_area") @db.VarChar(100)
  currentPublishedVersionId String?  @map("current_published_version_id") @db.Uuid
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  tenant   Tenant          @relation(fields: [tenantId], references: [id])
  versions ClauseVersion[]

  @@index([tenantId])
  @@index([tenantId, jurisdiction])
  @@map("clauses")
}

model ClauseVersion {
  id            String   @id @default(uuid()) @db.Uuid
  clauseId      String   @map("clause_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  versionNumber Int      @map("version_number")
  content       String   @db.Text
  parameters    Json?    @db.JsonB
  metadata      Json?    @db.JsonB
  rules         Json     @default("[]") @db.JsonB // Rule[] embedded
  status        String   @default("draft") @db.VarChar(20)
  validFrom     DateTime? @map("valid_from") @db.Date
  validUntil    DateTime? @map("valid_until") @db.Date
  authorId      String   @map("author_id") @db.Uuid
  reviewerId    String?  @map("reviewer_id") @db.Uuid
  publishedAt   DateTime? @map("published_at")
  createdAt     DateTime @default(now()) @map("created_at")

  clause   Clause @relation(fields: [clauseId], references: [id])
  author   User   @relation("ClauseVersionAuthor", fields: [authorId], references: [id])
  reviewer User?  @relation("ClauseVersionReviewer", fields: [reviewerId], references: [id])

  @@unique([clauseId, versionNumber])
  @@index([tenantId])
  @@index([clauseId, status])
  @@map("clause_versions")
}

model Template {
  id                        String   @id @default(uuid()) @db.Uuid
  tenantId                  String   @map("tenant_id") @db.Uuid
  title                     String   @db.VarChar(500)
  description               String?  @db.Text
  category                  String?  @db.VarChar(100)
  jurisdiction              String   @db.VarChar(10)
  legalArea                 String?  @map("legal_area") @db.VarChar(100)
  tags                      String[] @default([])
  currentPublishedVersionId String?  @map("current_published_version_id") @db.Uuid
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  tenant   Tenant            @relation(fields: [tenantId], references: [id])
  versions TemplateVersion[]

  @@index([tenantId])
  @@index([tenantId, jurisdiction])
  @@map("templates")
}

model TemplateVersion {
  id                    String   @id @default(uuid()) @db.Uuid
  templateId            String   @map("template_id") @db.Uuid
  tenantId              String   @map("tenant_id") @db.Uuid
  versionNumber         Int      @map("version_number")
  structure             Json     @db.JsonB // Section[] with Slots
  interviewFlowId       String?  @map("interview_flow_id") @db.Uuid
  defaultStyleTemplateId String? @map("default_style_template_id") @db.Uuid
  metadata              Json?    @db.JsonB
  status                String   @default("draft") @db.VarChar(20)
  authorId              String   @map("author_id") @db.Uuid
  reviewerId            String?  @map("reviewer_id") @db.Uuid
  publishedAt           DateTime? @map("published_at")
  createdAt             DateTime @default(now()) @map("created_at")

  template       Template       @relation(fields: [templateId], references: [id])
  author         User           @relation("TemplateVersionAuthor", fields: [authorId], references: [id])
  reviewer       User?          @relation("TemplateVersionReviewer", fields: [reviewerId], references: [id])
  interviewFlow  InterviewFlow? @relation(fields: [interviewFlowId], references: [id])

  @@unique([templateId, versionNumber])
  @@index([tenantId])
  @@index([templateId, status])
  @@map("template_versions")
}

model InterviewFlow {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  title             String   @db.VarChar(500)
  questions         Json     @db.JsonB // Question[] with Conditions
  createdAt         DateTime @default(now()) @map("created_at")

  tenant            Tenant            @relation(fields: [tenantId], references: [id])
  templateVersions  TemplateVersion[]

  @@index([tenantId])
  @@map("interview_flows")
}

// ============================================================
// CONTRACT CONTEXT (Tenant / Lawfirm)
// ============================================================

model ContractInstance {
  id                  String   @id @default(uuid()) @db.Uuid
  tenantId            String   @map("tenant_id") @db.Uuid
  creatorId           String   @map("creator_id") @db.Uuid
  title               String   @db.VarChar(500)
  clientReference     String?  @map("client_reference") @db.VarChar(255)
  tags                String[] @default([])
  templateVersionId   String   @map("template_version_id") @db.Uuid
  clauseVersionIds    String[] @map("clause_version_ids") @db.Uuid
  answers             Json     @default("{}") @db.JsonB
  selectedSlots       Json     @default("{}") @db.JsonB
  validationState     String   @default("valid") @map("validation_state") @db.VarChar(20)
  validationMessages  Json?    @map("validation_messages") @db.JsonB
  status              String   @default("draft") @db.VarChar(20)
  completedAt         DateTime? @map("completed_at")
  visibility          String   @default("private") @db.VarChar(20)
  teamId              String?  @map("team_id") @db.Uuid
  sourceTemplateId    String?  @map("source_template_id") @db.Uuid
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  tenant      Tenant      @relation(fields: [tenantId], references: [id])
  creator     User        @relation("ContractCreator", fields: [creatorId], references: [id])
  exportJobs  ExportJob[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, creatorId])
  @@map("contract_instances")
}

model LawFirmTemplate {
  id                      String   @id @default(uuid()) @db.Uuid
  tenantId                String   @map("tenant_id") @db.Uuid
  title                   String   @db.VarChar(500)
  description             String?  @db.Text
  sourceContractInstanceId String? @map("source_contract_instance_id") @db.Uuid
  sourceTemplateVersionId String   @map("source_template_version_id") @db.Uuid
  customAnswers           Json?    @map("custom_answers") @db.JsonB
  customSlotSelections    Json?    @map("custom_slot_selections") @db.JsonB
  status                  String   @default("draft") @db.VarChar(20)
  visibility              String   @default("private") @db.VarChar(20)
  teamId                  String?  @map("team_id") @db.Uuid
  tags                    String[] @default([])
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("law_firm_templates")
}

// ============================================================
// EXPORT CONTEXT
// ============================================================

model ExportJob {
  id                 String   @id @default(uuid()) @db.Uuid
  tenantId           String   @map("tenant_id") @db.Uuid
  contractInstanceId String   @map("contract_instance_id") @db.Uuid
  requestedBy        String   @map("requested_by") @db.Uuid
  format             String   @db.VarChar(10) // docx | odt
  styleTemplateId    String?  @map("style_template_id") @db.Uuid
  batchId            String?  @map("batch_id") @db.Uuid
  status             String   @default("queued") @db.VarChar(20)
  resultStoragePath  String?  @map("result_storage_path") @db.VarChar(1000)
  resultFileSize     BigInt?  @map("result_file_size")
  errorMessage       String?  @map("error_message") @db.VarChar(2000)
  retryCount         Int      @default(0) @map("retry_count")
  queuedAt           DateTime @default(now()) @map("queued_at")
  startedAt          DateTime? @map("started_at")
  completedAt        DateTime? @map("completed_at")

  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  contractInstance ContractInstance @relation(fields: [contractInstanceId], references: [id])
  requester        User             @relation(fields: [requestedBy], references: [id])

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, batchId])
  @@index([contractInstanceId])
  @@map("export_jobs")
}

model StyleTemplate {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  name            String   @db.VarChar(255)
  description     String?  @db.VarChar(1000)
  type            String   @default("lawfirm") @db.VarChar(20) // system | vendor | lawfirm
  templateFile    String?  @map("template_file") @db.VarChar(1000)
  headerConfig    Json?    @map("header_config") @db.JsonB
  footerConfig    Json?    @map("footer_config") @db.JsonB
  logoUrl         String?  @map("logo_url") @db.VarChar(2048)
  primaryFont     String   @default("Arial") @map("primary_font") @db.VarChar(100)
  fontSize        Int      @default(11) @map("font_size")
  headerFont      String?  @map("header_font") @db.VarChar(100)
  headerFontSize  Int?     @map("header_font_size")
  primaryColor    String?  @map("primary_color") @db.VarChar(7)
  secondaryColor  String?  @map("secondary_color") @db.VarChar(7)
  footerText      String?  @map("footer_text") @db.VarChar(500)
  pageMargins     Json?    @map("page_margins") @db.JsonB
  isDefault       Boolean  @default(false) @map("is_default")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("style_templates")
}

# External Secrets Operator - ClusterSecretStore & SecretStore
# Configures the secret provider backend for Servanda Office production.
#
# Supported providers (uncomment the one matching your infrastructure):
#   1. HashiCorp Vault (default, matches existing vault-backend reference)
#   2. AWS Secrets Manager
#   3. GCP Secret Manager
#
# Prerequisites:
#   - External Secrets Operator must be installed in the cluster
#     (helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace)
#   - Provider-specific authentication must be configured

---
# ============================================================================
# ClusterSecretStore — Cluster-wide secret provider (available to all namespaces)
# ============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend-cluster
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: servanda-office
spec:
  provider:
    # --- Option 1: HashiCorp Vault (DEFAULT) ---
    vault:
      server: "https://vault.servanda.internal:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "servanda-office"
          serviceAccountRef:
            name: "vault-auth"
            namespace: "servanda-office"

    # --- Option 2: AWS Secrets Manager ---
    # Uncomment below and comment out the vault block above to use AWS SM.
    # aws:
    #   service: SecretsManager
    #   region: eu-central-1
    #   auth:
    #     jwt:
    #       serviceAccountRef:
    #         name: "aws-secrets-sa"
    #         namespace: "servanda-office"

    # --- Option 3: GCP Secret Manager ---
    # Uncomment below and comment out the vault block above to use GCP SM.
    # gcpsm:
    #   projectID: "servanda-prod"
    #   auth:
    #     workloadIdentity:
    #       clusterLocation: europe-west3
    #       clusterName: servanda-prod
    #       clusterProjectID: servanda-prod
    #       serviceAccountRef:
    #         name: "gcp-secrets-sa"
    #         namespace: "servanda-office"

---
# ============================================================================
# SecretStore — Namespace-scoped secret provider for servanda-office
# ============================================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: servanda-office
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: servanda-office
  annotations:
    external-secrets.io/description: "Namespace-scoped SecretStore for Servanda Office production secrets"
spec:
  provider:
    # --- Option 1: HashiCorp Vault (DEFAULT) ---
    vault:
      server: "https://vault.servanda.internal:8200"
      path: "secret"
      version: "v2"
      namespace: "servanda"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "servanda-office"
          serviceAccountRef:
            name: "vault-auth"

    # --- Option 2: AWS Secrets Manager ---
    # aws:
    #   service: SecretsManager
    #   region: eu-central-1
    #   auth:
    #     jwt:
    #       serviceAccountRef:
    #         name: "aws-secrets-sa"

    # --- Option 3: GCP Secret Manager ---
    # gcpsm:
    #   projectID: "servanda-prod"
    #   auth:
    #     workloadIdentity:
    #       clusterLocation: europe-west3
    #       clusterName: servanda-prod
    #       clusterProjectID: servanda-prod
    #       serviceAccountRef:
    #         name: "gcp-secrets-sa"

  # Conditions to check store health
  conditions:
    - type: Ready
      status: "True"
  # Retry settings for secret fetching
  retrySettings:
    maxRetries: 5
    retryInterval: "10s"
